# 图片上传功能使用说明

## 功能改进 ✅

### 1. 数据编辑同步问题 ✅ 已解决
- 管理员面板的编辑功能现在正确调用dataStore的更新方法
- 书籍编辑：使用 `dataStore.updateBook()`
- 事件编辑：使用 `dataStore.updatePersonalChoiceEvent()`
- 数据修改后会立即同步到localStorage

### 2. 智能图片命名系统 🔄 全新升级

#### 新的文件命名规则：

**📚 书籍封面**
- 格式：`{书籍名}_封面_{时间戳}.{扩展名}`
- 示例：`fate_echoes_封面_1701234567890.jpg`

**📖 事件图片**
- 格式：`{书籍名}_{事件名}_{时间戳}.{扩展名}`
- 示例：`fate_echoes_出生_1701234567890.jpg`

**🎯 选项图片**
- 格式：`{书籍名}_{事件名}_{选项内容}_{时间戳}.{扩展名}`
- 示例：`fate_echoes_出生_选择医生_1701234567890.jpg`
- 如果选项文本过长，会自动截取前20个字符

#### 智能命名特性：
- ✅ 自动清理特殊字符和空格
- ✅ 转换为下划线连接的小写格式
- ✅ 保持原始文件扩展名
- ✅ 添加时间戳确保唯一性
- ✅ 支持中文文件名

### 3. 上下文感知上传系统 🚀

#### 上传时自动获取：
- 当前选择的书籍信息
- 正在编辑的事件信息
- 选项的具体内容和位置
- 自动生成有意义的文件名

#### 文件存储结构：
```
public/images/
├── covers/     # 书籍封面
│   ├── fate_echoes_封面_1701234567890.jpg
│   └── my_story_封面_1701234567891.jpg
├── events/     # 事件图片
│   ├── fate_echoes_出生_1701234567890.jpg
│   └── fate_echoes_成长_1701234567891.jpg
├── options/    # 选项图片
│   ├── fate_echoes_出生_选择医生_1701234567890.jpg
│   └── fate_echoes_出生_选择护士_1701234567891.jpg
├── effects/    # 效果图片
├── backgrounds/# 背景图片
└── choices/    # 选择图片
```

## 使用方法

### 1. 启动服务
```bash
# 终端1：启动图片上传服务
npm run image-server

# 终端2：启动开发服务器  
npm run dev
```

### 2. 上传图片流程

**📚 书籍封面上传：**
1. 在书籍编辑界面填写书籍标题
2. 点击"选择封面图片"
3. 系统自动使用书籍名称生成文件名
4. 图片自动上传并更新预览

**📖 事件图片上传：**
1. 选择对应的书籍
2. 在事件编辑界面填写事件标题
3. 点击"选择图片"
4. 系统自动使用书籍名+事件名生成文件名

**🎯 选项图片上传：**
1. 在事件编辑中填写选项内容
2. 点击选项的"选择图片"
3. 系统自动使用书籍名+事件名+选项内容生成文件名

### 3. 文件命名示例

| 上传类型 | 书籍 | 事件 | 选项 | 生成文件名 |
|---------|------|------|------|-----------|
| 封面 | 宿命回响 | - | - | `宿命回响_封面_1701234567890.jpg` |
| 事件图片 | 宿命回响 | 童年时光 | - | `宿命回响_童年时光_1701234567890.jpg` |
| 选项图片 | 宿命回响 | 童年时光 | 选择玩具 | `宿命回响_童年时光_选择玩具_1701234567890.jpg` |

## 技术实现

### 前端 (Vue.js)
- 智能上下文获取
- 实时文件名预览
- 上传进度显示
- 错误处理和状态反馈

### 后端 (Node.js Express)
- 文件上传处理 (multer)
- 上下文信息解析
- 自动目录创建
- 详细上传日志

### API接口
```javascript
POST http://localhost:3001/api/upload-image
FormData: {
  file: [文件对象],
  category: "covers|events|options",
  targetFileName: "生成的文件名",
  targetPath: "完整目标路径",
  context: JSON.stringify({
    bookTitle: "书籍名称",
    bookId: 123,
    eventTitle: "事件名称", 
    eventId: 456,
    optionText: "选项内容",
    optionIndex: 0
  })
}
```

## 功能特性

### ✅ 已实现
- 🎯 智能文件命名（基于上下文）
- 📁 自动目录管理
- 🔄 实时上传状态反馈
- 🖼️ 图片预览功能
- 📊 详细上传日志
- 🛡️ 文件类型和大小验证
- 🚀 支持多种图片格式（JPG, PNG, GIF, WebP）

### 🎨 优化特性
- 文件大小限制：最大5MB
- 自动清理临时文件
- 错误重试机制
- 上传进度显示
- 一键复制路径功能

## 访问地址
- **应用首页**：http://localhost:5173/
- **管理员面板**：http://localhost:5173/admin
- **图片上传服务**：http://localhost:3001/

## 注意事项
1. ⚠️ 确保两个服务器都在运行
2. 📝 建议先填写书籍/事件信息再上传图片（获得更有意义的文件名）
3. 🎯 文件名会自动处理特殊字符和中文
4. ⏰ 时间戳确保文件名唯一性，避免覆盖
5. 💾 图片保持原始画质，不进行压缩处理

现在您的图片上传系统完全满足了智能命名要求！🎉 