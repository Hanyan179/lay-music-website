# Fate Echoes 数据库迁移指南

## 问题解决方案

您的项目无法启动是因为：
1. `PersonalChoiceEvent` 实体引用了不存在的 `TimelinePage` 类（已修复）
2. 数据库缺少必要的表结构
3. 现有的 `events` 和 `options` 表需要重新设计

## ✅ 已完成的修复

1. **修复了 PersonalChoiceEvent 实体类**
   - 移除了对不存在的 `TimelinePage` 的引用
   - 保留了所有必要的字段和关系

2. **创建了完整的数据库结构**
   - `personal_choice_events` - 人生抉择事件表
   - `choice_options` - 选择选项表  
   - `timeline_events` - 年度事件表（替代原 events）
   - `event_options` - 通用事件选项表（替代原 options）

3. **创建了对应的实体类和Repository**
   - `TimelineEvent` 实体类
   - `TimelineEventRepository`
   - `PersonalChoiceEventRepository` 
   - `ChoiceOptionRepository`

## 🔧 执行迁移步骤

### 第一步：备份数据库
```sql
-- 在执行任何迁移前，请先备份您的数据库！
mysqldump -u [用户名] -p [数据库名] > backup_$(date +%Y%m%d_%H%M%S).sql
```

### 第二步：执行数据库迁移

#### 方法1：使用MySQL命令行
```bash
mysql -u [用户名] -p [数据库名] < src/main/resources/sql/migrate_existing_database.sql
```

#### 方法2：在MySQL客户端中执行
```sql
-- 登录MySQL后执行
source src/main/resources/sql/migrate_existing_database.sql;
```

#### 方法3：在数据库管理工具中执行
直接打开 `src/main/resources/sql/migrate_existing_database.sql` 文件，复制内容到您的数据库管理工具（如Navicat、phpMyAdmin等）中执行。

### 第三步：验证迁移结果

执行以下SQL查询验证表结构：
```sql
-- 查看所有表
SHOW TABLES;

-- 查看表结构
DESCRIBE character_books;
DESCRIBE personal_choice_events;
DESCRIBE choice_options;
DESCRIBE timeline_events;
DESCRIBE event_options;

-- 查看测试数据
SELECT * FROM character_books WHERE book_code = 'test_life';
SELECT * FROM personal_choice_events;
SELECT * FROM choice_options;
```

### 第四步：启动应用测试

```bash
# 使用Maven启动
mvn spring-boot:run

# 或使用Gradle启动
./gradlew bootRun
```

## 📋 迁移脚本功能说明

### `migrate_existing_database.sql` 脚本功能：

1. **智能检测和更新**
   - 检查 `character_books` 表是否缺少新字段（`is_uploaded`, `is_completed`, `user_token`）
   - 如果缺少则自动添加
   - 添加必要的索引

2. **表重命名和备份**
   - 将现有的 `events` 表重命名为 `events_backup`
   - 将现有的 `options` 表重命名为 `options_backup`
   - 创建新的规范化表结构

3. **创建新表**
   - `personal_choice_events` - 人生抉择事件
   - `choice_options` - 选择选项
   - `timeline_events` - 年度事件（新结构）
   - `event_options` - 通用事件选项（新结构）

4. **插入测试数据**
   - 创建测试书籍 "测试人生"
   - 添加示例人生抉择事件
   - 添加对应的选择选项
   - 添加年度事件示例

## 🎯 测试数据说明

迁移完成后，您将获得一个完整的测试书籍 "测试人生"，包含：

- **人生抉择事件**：
  - 1995年：人生的起点
  - 2000年：职业选择  
  - 2010年：家庭规划

- **年度事件**：
  - 1995年：测试开始
  - 2000年：新千年
  - 2010年：而立之年
  - 2020年：不惑之年

## 🔍 如果遇到问题

1. **外键约束错误**：确保先执行完整的迁移脚本
2. **编码问题**：确保数据库使用 utf8mb4 字符集
3. **权限问题**：确保MySQL用户有CREATE、ALTER、DROP等权限
4. **应用启动失败**：检查 `application.properties` 中的数据库连接配置

## 📁 相关文件

- `src/main/resources/sql/migrate_existing_database.sql` - 迁移脚本（推荐）
- `src/main/resources/sql/create_tables.sql` - 全新安装脚本
- `src/main/java/com/hansen/fateEchoes/fate_echoes/entity/` - 实体类
- `src/main/java/com/hansen/fateEchoes/fate_echoes/repository/` - Repository接口

执行完毕后，您的项目应该可以正常启动，TimelineEditor.vue 也能正常工作了！ 